<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CliTri - R√©servations</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide-static/0.263.1/font/lucide.min.css">
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Ic√¥nes Lucide
    const Icon = ({ name, className = "" }) => <i className={`lucide lucide-${name} ${className}`}></i>;

    // Utilitaires de stockage avec fallback
    const storage = {
      async get(key) {
        try {
          // Essayer avec window.storage si disponible
          if (window.storage && typeof window.storage.get === 'function') {
            const result = await window.storage.get(key);
            return result ? JSON.parse(result.value) : null;
          }
        } catch (error) {
          console.warn('window.storage.get error, using localStorage:', error);
        }
        
        // Fallback vers localStorage
        try {
          const item = localStorage.getItem(key);
          return item ? JSON.parse(item) : null;
        } catch (error) {
          console.error('Storage get error:', error);
          return null;
        }
      },
      async set(key, value) {
        try {
          // Essayer avec window.storage si disponible
          if (window.storage && typeof window.storage.set === 'function') {
            await window.storage.set(key, JSON.stringify(value));
            return true;
          }
        } catch (error) {
          console.warn('window.storage.set error, using localStorage:', error);
        }
        
        // Fallback vers localStorage
        try {
          localStorage.setItem(key, JSON.stringify(value));
          return true;
        } catch (error) {
          console.error('Storage set error:', error);
          return false;
        }
      }
    };

    // Donn√©es initiales
    const INITIAL_USERS = [
      { email: 'clara.boveziemann@gmail.com', role: 'admin' }
    ];

    const INITIAL_SLOTS = [
      { id: 1, type: 'natation', day: 'Lundi', startTime: '18:00', duration: 60, capacity: 20, bookings: [], waitlist: [], active: true },
      { id: 2, type: 'natation', day: 'Mercredi', startTime: '19:00', duration: 60, capacity: 20, bookings: [], waitlist: [], active: true },
      { id: 3, type: 'crossfit', day: 'Mardi', startTime: '18:30', duration: 60, capacity: 15, bookings: [], waitlist: [], active: true },
      { id: 4, type: 'crossfit', day: 'Jeudi', startTime: '18:30', duration: 60, capacity: 15, bookings: [], waitlist: [], active: true }
    ];

    // Fonction pour formater l'heure de fin
    const getEndTime = (startTime, duration) => {
      const [hours, minutes] = startTime.split(':').map(Number);
      const endMinutes = hours * 60 + minutes + duration;
      const endHours = Math.floor(endMinutes / 60) % 24;
      const endMins = endMinutes % 60;
      return `${String(endHours).padStart(2, '0')}:${String(endMins).padStart(2, '0')}`;
    };

    // Fonction pour envoyer une notification email (simul√©e)
    const sendEmailNotification = (email, subject, message) => {
      console.log(`üìß Email envoy√© √† ${email}`);
      console.log(`Sujet: ${subject}`);
      console.log(`Message: ${message}`);
      // Dans une vraie application, ici on appellerait une API pour envoyer l'email
    };

    function App() {
      const [user, setUser] = useState(null);
      const [view, setView] = useState('login');
      const [slots, setSlots] = useState([]);
      const [events, setEvents] = useState([]);
      const [users, setUsers] = useState([]);
      const [loading, setLoading] = useState(true);

      // Charger les donn√©es au d√©marrage
      useEffect(() => {
        loadData();
      }, []);

      // V√©rifier et r√©initialiser les inscriptions chaque dimanche √† 21h
      useEffect(() => {
        const checkAndResetBookings = async () => {
          const lastReset = await storage.get('lastReset');
          const now = new Date();
          const dayOfWeek = now.getDay();
          const hours = now.getHours();
          
          // Si c'est dimanche (0) apr√®s 21h
          if (dayOfWeek === 0 && hours >= 21) {
            const todayStr = now.toDateString();
            if (lastReset !== todayStr) {
              const resetSlots = slots.map(slot => ({ 
                ...slot, 
                bookings: [], 
                waitlist: [] 
              }));
              await saveSlots(resetSlots);
              await storage.set('lastReset', todayStr);
            }
          }
        };

        if (slots.length > 0) {
          checkAndResetBookings();
          // V√©rifier toutes les heures
          const interval = setInterval(checkAndResetBookings, 3600000);
          return () => clearInterval(interval);
        }
      }, [slots]);

      // Nettoyer les √©v√©nements pass√©s
      useEffect(() => {
        const cleanOldEvents = async () => {
          const now = new Date();
          const filteredEvents = events.filter(event => {
            const eventDate = new Date(event.date);
            const eventEnd = new Date(eventDate.getTime() + event.duration * 60000);
            return eventEnd > now;
          });
          
          if (filteredEvents.length !== events.length) {
            await saveEvents(filteredEvents);
          }
        };

        if (events.length > 0) {
          cleanOldEvents();
          // V√©rifier toutes les heures
          const interval = setInterval(cleanOldEvents, 3600000);
          return () => clearInterval(interval);
        }
      }, [events]);

      const loadData = async () => {
        setLoading(true);
        const storedSlots = await storage.get('slots');
        const storedEvents = await storage.get('events');
        const storedUsers = await storage.get('users');
        
        setSlots(storedSlots || INITIAL_SLOTS);
        setEvents(storedEvents || []);
        setUsers(storedUsers || INITIAL_USERS);
        setLoading(false);
      };

      const saveSlots = async (newSlots) => {
        setSlots(newSlots);
        await storage.set('slots', newSlots);
      };

      const saveEvents = async (newEvents) => {
        setEvents(newEvents);
        await storage.set('events', newEvents);
      };

      const saveUsers = async (newUsers) => {
        setUsers(newUsers);
        await storage.set('users', newUsers);
      };

      const handleLogin = (email, role) => {
        setUser({ email, role });
        setView('bookings');
      };

      const handleBookSlot = (slotId) => {
        const newSlots = slots.map(slot => {
          if (slot.id === slotId) {
            // V√©rifier si l'utilisateur est d√©j√† inscrit
            if (slot.bookings.includes(user.email) || slot.waitlist.includes(user.email)) {
              return slot;
            }

            // Si il y a de la place, inscrire directement
            if (slot.bookings.length < slot.capacity) {
              return { ...slot, bookings: [...slot.bookings, user.email] };
            } else {
              // Sinon, ajouter √† la liste d'attente
              return { ...slot, waitlist: [...slot.waitlist, user.email] };
            }
          }
          return slot;
        });
        saveSlots(newSlots);
      };

      const handleCancelSlot = (slotId) => {
        const newSlots = slots.map(slot => {
          if (slot.id === slotId) {
            const wasBooked = slot.bookings.includes(user.email);
            
            if (wasBooked) {
              // Retirer des inscrits
              const newBookings = slot.bookings.filter(email => email !== user.email);
              
              // Si il y a quelqu'un en liste d'attente, le faire passer
              if (slot.waitlist.length > 0) {
                const firstWaiting = slot.waitlist[0];
                const newWaitlist = slot.waitlist.slice(1);
                
                // Envoyer notification
                sendEmailNotification(
                  firstWaiting,
                  'Place disponible !',
                  `Une place s'est lib√©r√©e pour le cr√©neau ${slot.type} du ${slot.day} √† ${slot.startTime}. Vous avez √©t√© automatiquement inscrit(e) !`
                );
                
                return { 
                  ...slot, 
                  bookings: [...newBookings, firstWaiting], 
                  waitlist: newWaitlist 
                };
              }
              
              return { ...slot, bookings: newBookings };
            } else {
              // Retirer de la liste d'attente
              const newWaitlist = slot.waitlist.filter(email => email !== user.email);
              return { ...slot, waitlist: newWaitlist };
            }
          }
          return slot;
        });
        saveSlots(newSlots);
      };

      const handleBookEvent = (eventId) => {
        const newEvents = events.map(event => {
          if (event.id === eventId) {
            // V√©rifier si l'utilisateur est d√©j√† inscrit
            if (event.participants.includes(user.email) || event.waitlist.includes(user.email)) {
              return event;
            }

            // Si capacit√© illimit√©e ou il y a de la place
            if (event.capacity === 'unlimited' || event.participants.length < event.capacity) {
              return { ...event, participants: [...event.participants, user.email] };
            } else {
              // Ajouter √† la liste d'attente
              return { ...event, waitlist: [...event.waitlist, user.email] };
            }
          }
          return event;
        });
        saveEvents(newEvents);
      };

      const handleCancelEvent = (eventId) => {
        const newEvents = events.map(event => {
          if (event.id === eventId) {
            const wasParticipant = event.participants.includes(user.email);
            
            if (wasParticipant) {
              // Retirer des participants
              const newParticipants = event.participants.filter(email => email !== user.email);
              
              // Si il y a quelqu'un en liste d'attente et capacit√© limit√©e
              if (event.waitlist.length > 0 && event.capacity !== 'unlimited') {
                const firstWaiting = event.waitlist[0];
                const newWaitlist = event.waitlist.slice(1);
                
                // Envoyer notification
                sendEmailNotification(
                  firstWaiting,
                  'Place disponible !',
                  `Une place s'est lib√©r√©e pour l'√©v√©nement "${event.title}" le ${new Date(event.date).toLocaleDateString('fr-FR')}. Vous avez √©t√© automatiquement inscrit(e) !`
                );
                
                return { 
                  ...event, 
                  participants: [...newParticipants, firstWaiting], 
                  waitlist: newWaitlist 
                };
              }
              
              return { ...event, participants: newParticipants };
            } else {
              // Retirer de la liste d'attente
              const newWaitlist = event.waitlist.filter(email => email !== user.email);
              return { ...event, waitlist: newWaitlist };
            }
          }
          return event;
        });
        saveEvents(newEvents);
      };

      if (loading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
            <div className="text-xl text-gray-600">Chargement...</div>
          </div>
        );
      }

      if (view === 'login') {
        return <LoginView onLogin={handleLogin} users={users} />;
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
          <Navigation user={user} view={view} setView={setView} setUser={setUser} />
          
          <div className="container mx-auto px-4 py-8">
            {view === 'bookings' && (
              <BookingsView 
                user={user} 
                slots={slots} 
                onBook={handleBookSlot}
                onCancel={handleCancelSlot}
              />
            )}
            
            {view === 'events' && (
              <EventsView 
                user={user} 
                events={events}
                onBook={handleBookEvent}
                onCancel={handleCancelEvent}
              />
            )}
            
            {view === 'admin-slots' && user.role === 'admin' && (
              <AdminSlotsPanel 
                slots={slots} 
                saveSlots={saveSlots}
              />
            )}

            {view === 'admin-events' && user.role === 'admin' && (
              <AdminEventsPanel 
                events={events}
                saveEvents={saveEvents}
              />
            )}

            {view === 'admin-users' && user.role === 'admin' && (
              <AdminUsersPanel 
                users={users}
                saveUsers={saveUsers}
              />
            )}
          </div>
        </div>
      );
    }

    function LoginView({ onLogin, users }) {
      const [email, setEmail] = useState('');
      const [error, setError] = useState('');

      const handleSubmit = (e) => {
        e.preventDefault();
        setError('');
        
        const normalizedEmail = email.toLowerCase().trim();
        const user = users.find(u => u.email.toLowerCase() === normalizedEmail);
        
        if (user) {
          onLogin(user.email, user.role);
        } else {
          setError('Cette adresse email n\'est pas autoris√©e. Contactez un administrateur.');
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div className="text-center mb-8">
              <div className="inline-block p-4 bg-blue-100 rounded-full mb-4">
                <Icon name="waves" className="text-4xl text-blue-600" />
              </div>
              <h1 className="text-3xl font-bold text-gray-800 mb-2">CliTri</h1>
              <p className="text-gray-600">R√©servation de cr√©neaux</p>
            </div>

            <form onSubmit={handleSubmit} className="space-y-6">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Adresse email
                </label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="votre.email@exemple.com"
                  required
                />
              </div>

              {error && (
                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                  {error}
                </div>
              )}

              <button
                type="submit"
                className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
              >
                Se connecter
              </button>
            </form>
          </div>
        </div>
      );
    }

    function Navigation({ user, view, setView, setUser }) {
      const [showAdminMenu, setShowAdminMenu] = useState(false);

      return (
        <nav className="bg-white shadow-md">
          <div className="container mx-auto px-4">
            <div className="flex items-center justify-between h-16">
              <div className="flex items-center space-x-8">
                <div className="flex items-center space-x-2">
                  <Icon name="waves" className="text-2xl text-blue-600" />
                  <span className="font-bold text-xl text-gray-800">CliTri</span>
                </div>
                
                <div className="flex space-x-4">
                  <button
                    onClick={() => setView('bookings')}
                    className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                      view === 'bookings' 
                        ? 'bg-blue-100 text-blue-700' 
                        : 'text-gray-600 hover:bg-gray-100'
                    }`}
                  >
                    Cr√©neaux hebdo
                  </button>
                  
                  <button
                    onClick={() => setView('events')}
                    className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                      view === 'events' 
                        ? 'bg-blue-100 text-blue-700' 
                        : 'text-gray-600 hover:bg-gray-100'
                    }`}
                  >
                    √âv√©nements
                  </button>
                  
                  {user.role === 'admin' && (
                    <div className="relative">
                      <button
                        onClick={() => setShowAdminMenu(!showAdminMenu)}
                        className={`px-4 py-2 rounded-lg font-medium transition-colors flex items-center ${
                          view.startsWith('admin') 
                            ? 'bg-blue-100 text-blue-700' 
                            : 'text-gray-600 hover:bg-gray-100'
                        }`}
                      >
                        <Icon name="settings" className="inline mr-1" /> Admin
                        <Icon name={showAdminMenu ? "chevron-up" : "chevron-down"} className="inline ml-1 text-sm" />
                      </button>
                      
                      {showAdminMenu && (
                        <div className="absolute top-full left-0 mt-1 bg-white shadow-lg rounded-lg py-2 min-w-[200px] z-50">
                          <button
                            onClick={() => { setView('admin-users'); setShowAdminMenu(false); }}
                            className="w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-700"
                          >
                            <Icon name="users" className="inline mr-2 text-sm" />
                            Gestion utilisateurs
                          </button>
                          <button
                            onClick={() => { setView('admin-slots'); setShowAdminMenu(false); }}
                            className="w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-700"
                          >
                            <Icon name="calendar" className="inline mr-2 text-sm" />
                            Planning hebdomadaire
                          </button>
                          <button
                            onClick={() => { setView('admin-events'); setShowAdminMenu(false); }}
                            className="w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-700"
                          >
                            <Icon name="calendar-plus" className="inline mr-2 text-sm" />
                            √âv√©nements ponctuels
                          </button>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>

              <div className="flex items-center space-x-4">
                <span className="text-gray-700 text-sm">
                  <Icon name="user" className="inline mr-1" />
                  {user.email}
                  {user.role === 'admin' && (
                    <span className="ml-2 px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs font-medium">
                      Admin
                    </span>
                  )}
                </span>
                <button
                  onClick={() => {
                    setUser(null);
                    setView('login');
                  }}
                  className="text-gray-600 hover:text-gray-800"
                  title="Se d√©connecter"
                >
                  <Icon name="log-out" />
                </button>
              </div>
            </div>
          </div>
        </nav>
      );
    }

    function BookingsView({ user, slots, onBook, onCancel }) {
      const [filter, setFilter] = useState('all');
      const [countdown, setCountdown] = useState('');

      // Calculer le temps restant jusqu'√† dimanche 21h
      useEffect(() => {
        const updateCountdown = () => {
          const now = new Date();
          const dayOfWeek = now.getDay();
          const hours = now.getHours();
          const minutes = now.getMinutes();
          const seconds = now.getSeconds();

          // Calculer le prochain dimanche 21h
          let daysUntilSunday = (7 - dayOfWeek) % 7;
          if (daysUntilSunday === 0 && (hours > 21 || (hours === 21 && minutes > 0))) {
            daysUntilSunday = 7; // Si on est dimanche apr√®s 21h, aller au dimanche suivant
          }

          const nextReset = new Date(now);
          nextReset.setDate(now.getDate() + daysUntilSunday);
          nextReset.setHours(21, 0, 0, 0);

          const diff = nextReset - now;

          if (diff <= 0) {
            setCountdown('R√©initialisation en cours...');
            return;
          }

          const days = Math.floor(diff / (1000 * 60 * 60 * 24));
          const hoursLeft = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const minutesLeft = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          const secondsLeft = Math.floor((diff % (1000 * 60)) / 1000);

          let countdownText = '';
          if (days > 0) {
            countdownText = `${days}j ${hoursLeft}h ${minutesLeft}min`;
          } else if (hoursLeft > 0) {
            countdownText = `${hoursLeft}h ${minutesLeft}min ${secondsLeft}s`;
          } else {
            countdownText = `${minutesLeft}min ${secondsLeft}s`;
          }

          setCountdown(countdownText);
        };

        updateCountdown();
        const interval = setInterval(updateCountdown, 1000);
        return () => clearInterval(interval);
      }, []);

      // Filtrer uniquement les cr√©neaux actifs pour les utilisateurs
      const activeSlots = slots.filter(slot => slot.active !== false);

      const filteredSlots = filter === 'all' 
        ? activeSlots 
        : activeSlots.filter(slot => slot.type === filter);

      const groupedSlots = {
        natation: filteredSlots.filter(s => s.type === 'natation'),
        crossfit: filteredSlots.filter(s => s.type === 'crossfit'),
        v√©lo: filteredSlots.filter(s => s.type === 'v√©lo'),
        running: filteredSlots.filter(s => s.type === 'running')
      };

      const typeConfig = {
        natation: { icon: 'waves', color: 'blue', label: 'Natation' },
        crossfit: { icon: 'dumbbell', color: 'orange', label: 'CrossFit' },
        v√©lo: { icon: 'bike', color: 'green', label: 'V√©lo' },
        running: { icon: 'footprints', color: 'purple', label: 'Running' }
      };

      return (
        <div>
          <div className="mb-8">
            <div className="flex items-center justify-between mb-4">
              <h1 className="text-3xl font-bold text-gray-800">Cr√©neaux hebdomadaires</h1>
              
              {countdown && (
                <div className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-lg shadow-lg">
                  <div className="flex items-center gap-2">
                    <Icon name="timer" className="text-xl" />
                    <div>
                      <div className="text-xs font-medium opacity-90">R√©initialisation dans</div>
                      <div className="text-lg font-bold">{countdown}</div>
                    </div>
                  </div>
                </div>
              )}
            </div>
            
            <p className="text-gray-600 mb-4">Les inscriptions sont r√©initialis√©es chaque dimanche √† 21h</p>
            
            <div className="flex flex-wrap gap-2">
              <button
                onClick={() => setFilter('all')}
                className={`px-6 py-2 rounded-lg font-medium transition-colors ${
                  filter === 'all'
                    ? 'bg-blue-600 text-white'
                    : 'bg-white text-gray-700 hover:bg-gray-50'
                }`}
              >
                Tous
              </button>
              {Object.entries(typeConfig).map(([type, config]) => (
                <button
                  key={type}
                  onClick={() => setFilter(type)}
                  className={`px-6 py-2 rounded-lg font-medium transition-colors ${
                    filter === type
                      ? 'bg-blue-600 text-white'
                      : 'bg-white text-gray-700 hover:bg-gray-50'
                  }`}
                >
                  <Icon name={config.icon} className="inline mr-1" /> {config.label}
                </button>
              ))}
            </div>
          </div>

          {Object.entries(groupedSlots).map(([type, typeSlots]) => {
            if (typeSlots.length === 0) return null;
            const config = typeConfig[type];
            
            return (
              <div key={type} className="mb-8">
                <h2 className="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                  <Icon name={config.icon} className={`mr-2 text-${config.color}-600`} />
                  {config.label}
                </h2>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {typeSlots.map(slot => (
                    <SlotCard 
                      key={slot.id} 
                      slot={slot} 
                      user={user}
                      onBook={onBook}
                      onCancel={onCancel}
                    />
                  ))}
                </div>
              </div>
            );
          })}

          {filteredSlots.length === 0 && (
            <div className="bg-white rounded-xl shadow-md p-12 text-center">
              <Icon name="calendar-x" className="text-6xl text-gray-300 mb-4" />
              <p className="text-gray-600 text-lg">Aucun cr√©neau disponible pour ce filtre</p>
            </div>
          )}
        </div>
      );
    }

    function SlotCard({ slot, user, onBook, onCancel }) {
      const isBooked = slot.bookings.includes(user.email);
      const isWaitlisted = slot.waitlist.includes(user.email);
      const isFull = slot.bookings.length >= slot.capacity;
      const availableSpots = slot.capacity - slot.bookings.length;
      const waitlistPosition = slot.waitlist.indexOf(user.email) + 1;

      return (
        <div className="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition-shadow">
          <div className="flex justify-between items-start mb-4">
            <div>
              <h3 className="text-lg font-bold text-gray-800">{slot.day}</h3>
              <p className="text-gray-600 flex items-center mt-1">
                <Icon name="clock" className="mr-1 text-sm" />
                {slot.startTime} - {getEndTime(slot.startTime, slot.duration)}
              </p>
              <p className="text-sm text-gray-500 mt-1">
                Dur√©e: {slot.duration} min
              </p>
            </div>
            <span className={`px-3 py-1 rounded-full text-sm font-medium ${
              slot.type === 'natation' ? 'bg-blue-100 text-blue-700' :
              slot.type === 'crossfit' ? 'bg-orange-100 text-orange-700' :
              slot.type === 'v√©lo' ? 'bg-green-100 text-green-700' :
              'bg-purple-100 text-purple-700'
            }`}>
              {slot.type}
            </span>
          </div>

          <div className="mb-4">
            <div className="flex items-center justify-between mb-2">
              <span className="text-sm text-gray-600">Places disponibles</span>
              <span className={`font-semibold ${
                availableSpots === 0 ? 'text-red-600' : 'text-green-600'
              }`}>
                {availableSpots} / {slot.capacity}
              </span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-2">
              <div
                className={`h-2 rounded-full transition-all ${
                  availableSpots === 0 ? 'bg-red-500' : 'bg-green-500'
                }`}
                style={{ width: `${(slot.bookings.length / slot.capacity) * 100}%` }}
              />
            </div>
            
            {slot.waitlist.length > 0 && (
              <p className="text-xs text-gray-500 mt-2">
                <Icon name="users" className="inline text-xs mr-1" />
                {slot.waitlist.length} personne{slot.waitlist.length > 1 ? 's' : ''} en liste d'attente
              </p>
            )}
          </div>

          {isBooked ? (
            <div>
              <div className="bg-green-50 border border-green-200 text-green-700 px-3 py-2 rounded-lg text-sm mb-2 flex items-center">
                <Icon name="check-circle" className="mr-2" />
                Vous √™tes inscrit(e)
              </div>
              <button
                onClick={() => onCancel(slot.id)}
                className="w-full bg-red-600 text-white py-2 rounded-lg font-medium hover:bg-red-700 transition-colors"
              >
                <Icon name="x" className="inline mr-1" />
                Se d√©sinscrire
              </button>
            </div>
          ) : isWaitlisted ? (
            <div>
              <div className="bg-yellow-50 border border-yellow-200 text-yellow-700 px-3 py-2 rounded-lg text-sm mb-2 flex items-center">
                <Icon name="clock" className="mr-2" />
                Liste d'attente - Position #{waitlistPosition}
              </div>
              <button
                onClick={() => onCancel(slot.id)}
                className="w-full bg-gray-600 text-white py-2 rounded-lg font-medium hover:bg-gray-700 transition-colors"
              >
                Quitter la liste d'attente
              </button>
            </div>
          ) : (
            <button
              onClick={() => onBook(slot.id)}
              className={`w-full py-2 rounded-lg font-medium transition-colors ${
                isFull
                  ? 'bg-yellow-600 text-white hover:bg-yellow-700'
                  : 'bg-blue-600 text-white hover:bg-blue-700'
              }`}
            >
              {isFull ? (
                <>
                  <Icon name="clock" className="inline mr-1" />
                  Rejoindre la liste d'attente
                </>
              ) : (
                'R√©server'
              )}
            </button>
          )}
        </div>
      );
    }

    function EventsView({ user, events, onBook, onCancel }) {
      const sortedEvents = [...events].sort((a, b) => new Date(a.date) - new Date(b.date));

      return (
        <div>
          <h1 className="text-3xl font-bold text-gray-800 mb-8">√âv√©nements √† venir</h1>

          {sortedEvents.length === 0 ? (
            <div className="bg-white rounded-xl shadow-md p-12 text-center">
              <Icon name="calendar" className="text-6xl text-gray-300 mb-4" />
              <p className="text-gray-600 text-lg">Aucun √©v√©nement pr√©vu pour le moment</p>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {sortedEvents.map(event => (
                <EventCard
                  key={event.id}
                  event={event}
                  user={user}
                  onBook={onBook}
                  onCancel={onCancel}
                />
              ))}
            </div>
          )}
        </div>
      );
    }

    function EventCard({ event, user, onBook, onCancel }) {
      const isParticipant = event.participants.includes(user.email);
      const isWaitlisted = event.waitlist.includes(user.email);
      const isFull = event.capacity !== 'unlimited' && event.participants.length >= event.capacity;
      const waitlistPosition = event.waitlist.indexOf(user.email) + 1;

      return (
        <div className="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow">
          <div className="h-2 bg-gradient-to-r from-blue-500 to-purple-500"></div>
          
          <div className="p-6">
            <div className="mb-4">
              <h3 className="text-xl font-bold text-gray-800 mb-2">{event.title}</h3>
              {event.description && (
                <p className="text-gray-700 text-sm mb-3">{event.description}</p>
              )}
            </div>

            <div className="space-y-2 mb-4">
              <p className="text-gray-600 flex items-center">
                <Icon name="calendar" className="mr-2 text-sm" />
                {new Date(event.date).toLocaleDateString('fr-FR', { 
                  weekday: 'long', 
                  day: 'numeric', 
                  month: 'long', 
                  year: 'numeric' 
                })}
              </p>
              
              <p className="text-gray-600 flex items-center">
                <Icon name="clock" className="mr-2 text-sm" />
                {event.startTime} - {getEndTime(event.startTime, event.duration)}
              </p>

              <p className="text-gray-600 flex items-center">
                <Icon name="timer" className="mr-2 text-sm" />
                Dur√©e: {event.duration} min
              </p>
            </div>

            <div className="mb-4">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm text-gray-600">
                  {event.capacity === 'unlimited' ? 'Inscrits' : 'Places'}
                </span>
                <span className={`font-semibold ${
                  event.capacity === 'unlimited' ? 'text-blue-600' :
                  isFull ? 'text-red-600' : 'text-green-600'
                }`}>
                  {event.participants.length}
                  {event.capacity !== 'unlimited' && ` / ${event.capacity}`}
                  {event.capacity === 'unlimited' && ' inscrits'}
                </span>
              </div>
              
              {event.capacity !== 'unlimited' && (
                <div className="w-full bg-gray-200 rounded-full h-2">
                  <div
                    className={`h-2 rounded-full transition-all ${
                      isFull ? 'bg-red-500' : 'bg-green-500'
                    }`}
                    style={{ width: `${(event.participants.length / event.capacity) * 100}%` }}
                  />
                </div>
              )}
              
              {event.waitlist.length > 0 && (
                <p className="text-xs text-gray-500 mt-2">
                  <Icon name="users" className="inline text-xs mr-1" />
                  {event.waitlist.length} personne{event.waitlist.length > 1 ? 's' : ''} en liste d'attente
                </p>
              )}
            </div>

            {isParticipant ? (
              <div>
                <div className="bg-green-50 border border-green-200 text-green-700 px-3 py-2 rounded-lg text-sm mb-2 flex items-center">
                  <Icon name="check-circle" className="mr-2" />
                  Vous √™tes inscrit(e)
                </div>
                <button
                  onClick={() => onCancel(event.id)}
                  className="w-full bg-red-600 text-white py-2 rounded-lg font-medium hover:bg-red-700 transition-colors"
                >
                  <Icon name="x" className="inline mr-1" />
                  Se d√©sinscrire
                </button>
              </div>
            ) : isWaitlisted ? (
              <div>
                <div className="bg-yellow-50 border border-yellow-200 text-yellow-700 px-3 py-2 rounded-lg text-sm mb-2 flex items-center">
                  <Icon name="clock" className="mr-2" />
                  Liste d'attente - Position #{waitlistPosition}
                </div>
                <button
                  onClick={() => onCancel(event.id)}
                  className="w-full bg-gray-600 text-white py-2 rounded-lg font-medium hover:bg-gray-700 transition-colors"
                >
                  Quitter la liste d'attente
                </button>
              </div>
            ) : (
              <button
                onClick={() => onBook(event.id)}
                className={`w-full py-2 rounded-lg font-medium transition-colors ${
                  isFull
                    ? 'bg-yellow-600 text-white hover:bg-yellow-700'
                    : 'bg-blue-600 text-white hover:bg-blue-700'
                }`}
              >
                {isFull ? (
                  <>
                    <Icon name="clock" className="inline mr-1" />
                    Rejoindre la liste d'attente
                  </>
                ) : (
                  "S'inscrire"
                )}
              </button>
            )}
          </div>
        </div>
      );
    }

    function AdminUsersPanel({ users, saveUsers }) {
      const [editingUser, setEditingUser] = useState(null);
      const [showAddForm, setShowAddForm] = useState(false);

      const handleImportExcel = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(worksheet);

            const newUsers = json.map(row => ({
              email: row.email || row.Email || row.EMAIL || '',
              role: (row.role || row.Role || row.ROLE || 'membre').toLowerCase()
            })).filter(user => user.email && (user.role === 'admin' || user.role === 'membre'));

            if (newUsers.length > 0) {
              // Fusionner avec les utilisateurs existants, √©viter les doublons
              const existingEmails = new Set(users.map(u => u.email.toLowerCase()));
              const usersToAdd = newUsers.filter(u => !existingEmails.has(u.email.toLowerCase()));
              
              saveUsers([...users, ...usersToAdd]);
              alert(`${usersToAdd.length} utilisateur(s) import√©(s) avec succ√®s !`);
            } else {
              alert('Aucun utilisateur valide trouv√© dans le fichier.');
            }
          } catch (error) {
            alert('Erreur lors de la lecture du fichier Excel');
            console.error(error);
          }
        };
        reader.readAsArrayBuffer(file);
        e.target.value = ''; // Reset input
      };

      const handleAddUser = (email, role) => {
        const normalizedEmail = email.toLowerCase().trim();
        if (users.find(u => u.email.toLowerCase() === normalizedEmail)) {
          alert('Cet email existe d√©j√†');
          return;
        }
        saveUsers([...users, { email: normalizedEmail, role }]);
        setShowAddForm(false);
      };

      const handleUpdateRole = (email, newRole) => {
        saveUsers(users.map(u => 
          u.email === email ? { ...u, role: newRole } : u
        ));
      };

      const handleDeleteUser = (email) => {
        if (email === 'clara.boveziemann@gmail.com') {
          alert('Impossible de supprimer le premier administrateur');
          return;
        }
        if (confirm(`√ätes-vous s√ªr de vouloir supprimer ${email} ?`)) {
          saveUsers(users.filter(u => u.email !== email));
        }
      };

      return (
        <div>
          <h1 className="text-3xl font-bold text-gray-800 mb-6">Gestion des utilisateurs</h1>

          <div className="bg-white rounded-xl shadow-md p-6 mb-6">
            <div className="flex flex-wrap gap-4">
              <button
                onClick={() => setShowAddForm(!showAddForm)}
                className="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors"
              >
                <Icon name="user-plus" className="inline mr-2" />
                Ajouter un utilisateur
              </button>

              <label className="bg-green-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors cursor-pointer">
                <Icon name="upload" className="inline mr-2" />
                Importer Excel
                <input
                  type="file"
                  accept=".xlsx,.xls"
                  onChange={handleImportExcel}
                  className="hidden"
                />
              </label>

              <div className="flex-1"></div>

              <div className="text-sm text-gray-600 bg-blue-50 px-4 py-3 rounded-lg">
                <strong>Format Excel requis:</strong>
                <br />Colonnes: <code>email</code> et <code>role</code> (admin ou membre)
              </div>
            </div>
          </div>

          {showAddForm && (
            <div className="bg-white rounded-xl shadow-md p-6 mb-6">
              <h3 className="text-lg font-semibold mb-4">Ajouter un utilisateur</h3>
              <UserForm
                onSave={handleAddUser}
                onCancel={() => setShowAddForm(false)}
              />
            </div>
          )}

          <div className="bg-white rounded-xl shadow-md overflow-hidden">
            <table className="w-full">
              <thead className="bg-gray-50 border-b">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Email
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    R√¥le
                  </th>
                  <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-200">
                {users.map(user => (
                  <tr key={user.email} className="hover:bg-gray-50">
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                      {user.email}
                      {user.email === 'clara.boveziemann@gmail.com' && (
                        <span className="ml-2 text-xs text-blue-600">(Premier admin)</span>
                      )}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <select
                        value={user.role}
                        onChange={(e) => handleUpdateRole(user.email, e.target.value)}
                        className="text-sm border border-gray-300 rounded px-3 py-1 focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="membre">Membre</option>
                        <option value="admin">Admin</option>
                      </select>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm">
                      <button
                        onClick={() => handleDeleteUser(user.email)}
                        disabled={user.email === 'clara.boveziemann@gmail.com'}
                        className={`text-red-600 hover:text-red-800 ${
                          user.email === 'clara.boveziemann@gmail.com' ? 'opacity-50 cursor-not-allowed' : ''
                        }`}
                      >
                        <Icon name="trash-2" />
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          <div className="mt-4 text-sm text-gray-600">
            Total: {users.length} utilisateur(s) - {users.filter(u => u.role === 'admin').length} admin(s)
          </div>
        </div>
      );
    }

    function UserForm({ onSave, onCancel }) {
      const [email, setEmail] = useState('');
      const [role, setRole] = useState('membre');

      const handleSubmit = (e) => {
        e.preventDefault();
        onSave(email, role);
      };

      return (
        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                required
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">R√¥le</label>
              <select
                value={role}
                onChange={(e) => setRole(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              >
                <option value="membre">Membre</option>
                <option value="admin">Admin</option>
              </select>
            </div>
          </div>

          <div className="flex space-x-3">
            <button
              type="submit"
              className="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700"
            >
              Ajouter
            </button>
            <button
              type="button"
              onClick={onCancel}
              className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg font-medium hover:bg-gray-400"
            >
              Annuler
            </button>
          </div>
        </form>
      );
    }

    function AdminSlotsPanel({ slots, saveSlots }) {
      const [editingSlot, setEditingSlot] = useState(null);
      const [showAddForm, setShowAddForm] = useState(false);

      const handleDelete = (slotId) => {
        const slot = slots.find(s => s.id === slotId);
        const hasBookings = slot.bookings.length > 0 || slot.waitlist.length > 0;
        
        if (hasBookings) {
          if (!confirm(`Ce cr√©neau a ${slot.bookings.length} inscription(s) et ${slot.waitlist.length} personne(s) en liste d'attente. √ätes-vous s√ªr de vouloir le supprimer ?`)) {
            return;
          }
        } else if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce cr√©neau ?')) {
          return;
        }
        
        saveSlots(slots.filter(s => s.id !== slotId));
      };

      const handleToggleActive = (slotId) => {
        saveSlots(slots.map(s => 
          s.id === slotId ? { ...s, active: !s.active } : s
        ));
      };

      const handleSaveSlot = (slot) => {
        if (slot.id) {
          saveSlots(slots.map(s => s.id === slot.id ? slot : s));
        } else {
          const newSlot = { 
            ...slot, 
            id: Date.now(), 
            bookings: [], 
            waitlist: [],
            active: true
          };
          saveSlots([...slots, newSlot]);
        }
        setEditingSlot(null);
        setShowAddForm(false);
      };

      // Grouper les cr√©neaux par statut
      const activeSlots = slots.filter(s => s.active !== false);
      const inactiveSlots = slots.filter(s => s.active === false);

      return (
        <div>
          <h1 className="text-3xl font-bold text-gray-800 mb-6">Gestion du planning hebdomadaire</h1>

          <div className="mb-6 flex items-center justify-between">
            <button
              onClick={() => setShowAddForm(true)}
              className="bg-green-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors"
            >
              <Icon name="plus" className="inline mr-2" />
              Ajouter un cr√©neau
            </button>

            <div className="text-sm text-gray-600 bg-blue-50 px-4 py-2 rounded-lg">
              <strong>{activeSlots.length}</strong> cr√©neau(x) actif(s) ‚Ä¢ <strong>{inactiveSlots.length}</strong> d√©sactiv√©(s)
            </div>
          </div>

          {showAddForm && (
            <div className="bg-white rounded-xl shadow-md p-6 mb-6">
              <h3 className="text-lg font-semibold mb-4">Nouveau cr√©neau</h3>
              <SlotForm
                onSave={handleSaveSlot}
                onCancel={() => setShowAddForm(false)}
              />
            </div>
          )}

          {/* Cr√©neaux actifs */}
          {activeSlots.length > 0 && (
            <div className="mb-8">
              <h2 className="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <span className="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                Cr√©neaux actifs
              </h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {activeSlots.map(slot => (
                  <SlotAdminCard 
                    key={slot.id}
                    slot={slot}
                    editingSlot={editingSlot}
                    onEdit={setEditingSlot}
                    onSave={handleSaveSlot}
                    onCancel={() => setEditingSlot(null)}
                    onToggleActive={handleToggleActive}
                    onDelete={handleDelete}
                  />
                ))}
              </div>
            </div>
          )}

          {/* Cr√©neaux d√©sactiv√©s */}
          {inactiveSlots.length > 0 && (
            <div>
              <h2 className="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <span className="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                Cr√©neaux d√©sactiv√©s
              </h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {inactiveSlots.map(slot => (
                  <SlotAdminCard 
                    key={slot.id}
                    slot={slot}
                    editingSlot={editingSlot}
                    onEdit={setEditingSlot}
                    onSave={handleSaveSlot}
                    onCancel={() => setEditingSlot(null)}
                    onToggleActive={handleToggleActive}
                    onDelete={handleDelete}
                  />
                ))}
              </div>
            </div>
          )}
        </div>
      );
    }

    function SlotAdminCard({ slot, editingSlot, onEdit, onSave, onCancel, onToggleActive, onDelete }) {
      const isActive = slot.active !== false;

      if (editingSlot?.id === slot.id) {
        return (
          <div className="bg-white rounded-lg shadow-md p-6">
            <SlotForm
              slot={editingSlot}
              onSave={onSave}
              onCancel={onCancel}
            />
          </div>
        );
      }

      return (
        <div className={`bg-white rounded-lg shadow-md p-6 ${!isActive ? 'opacity-75 border-2 border-gray-300' : ''}`}>
          <div className="flex justify-between items-start mb-4">
            <div className="flex-1">
              <div className="flex items-center gap-2 mb-2">
                <h3 className="text-lg font-bold text-gray-800 flex items-center">
                  {slot.type === 'natation' && 'üèä'}
                  {slot.type === 'crossfit' && 'üí™'}
                  {slot.type === 'v√©lo' && 'üö¥'}
                  {slot.type === 'running' && 'üèÉ'}
                  <span className="ml-2">{slot.type}</span>
                </h3>
                {!isActive && (
                  <span className="px-2 py-1 bg-gray-200 text-gray-600 text-xs rounded-full">
                    D√©sactiv√©
                  </span>
                )}
              </div>
              <p className="text-gray-600">{slot.day}</p>
              <p className="text-gray-600">{slot.startTime} - {getEndTime(slot.startTime, slot.duration)}</p>
              <p className="text-sm text-gray-500 mt-1">
                Dur√©e: {slot.duration} min | Capacit√©: {slot.capacity} places
              </p>
            </div>
            <div className="flex gap-2 ml-4">
              <button
                onClick={() => onEdit(slot)}
                className="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-1"
                title="Modifier"
              >
                <Icon name="edit" className="text-base" />
                <span>Modifier</span>
              </button>
              <button
                onClick={() => onToggleActive(slot.id)}
                className={`${isActive ? 'bg-orange-100 hover:bg-orange-200 text-orange-700' : 'bg-green-100 hover:bg-green-200 text-green-700'} px-3 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-1`}
                title={isActive ? 'D√©sactiver' : 'Activer'}
              >
                <Icon name={isActive ? "eye-off" : "eye"} className="text-base" />
                <span>{isActive ? 'D√©sactiver' : 'Activer'}</span>
              </button>
              <button
                onClick={() => onDelete(slot.id)}
                className="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-1"
                title="Supprimer"
              >
                <Icon name="trash-2" className="text-base" />
                <span>Supprimer</span>
              </button>
            </div>
          </div>

          <div className="border-t pt-4">
            <p className="text-sm font-semibold text-gray-700 mb-2">
              Inscrits ({slot.bookings.length}/{slot.capacity}) :
            </p>
            {slot.bookings.length === 0 ? (
              <p className="text-sm text-gray-500 italic">Aucune r√©servation</p>
            ) : (
              <div className="space-y-1 max-h-32 overflow-y-auto">
                {slot.bookings.map((email, idx) => (
                  <div key={idx} className="text-sm text-gray-700 flex items-center">
                    <Icon name="check" className="text-green-600 mr-2 text-xs flex-shrink-0" />
                    <span className="truncate">{email}</span>
                  </div>
                ))}
              </div>
            )}

            {slot.waitlist.length > 0 && (
              <>
                <p className="text-sm font-semibold text-gray-700 mb-2 mt-4">
                  Liste d'attente ({slot.waitlist.length}) :
                </p>
                <div className="space-y-1 max-h-24 overflow-y-auto">
                  {slot.waitlist.map((email, idx) => (
                    <div key={idx} className="text-sm text-gray-700 flex items-center">
                      <Icon name="clock" className="text-yellow-600 mr-2 text-xs flex-shrink-0" />
                      <span className="truncate">#{idx + 1} - {email}</span>
                    </div>
                  ))}
                </div>
              </>
            )}
          </div>
        </div>
      );
    }

    function SlotForm({ slot, onSave, onCancel }) {
      const [formData, setFormData] = useState(slot || {
        type: 'natation',
        day: 'Lundi',
        startTime: '18:00',
        duration: 60,
        capacity: 20
      });

      const handleSubmit = (e) => {
        e.preventDefault();
        onSave({ 
          ...slot, 
          ...formData,
          duration: parseInt(formData.duration),
          capacity: parseInt(formData.capacity)
        });
      };

      const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];

      return (
        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Type d'entra√Ænement</label>
              <select
                value={formData.type}
                onChange={(e) => setFormData({ ...formData, type: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                required
              >
                <option value="natation">Natation</option>
                <option value="crossfit">CrossFit</option>
                <option value="v√©lo">V√©lo</option>
                <option value="running">Running</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Jour</label>
              <select
                value={formData.day}
                onChange={(e) => setFormData({ ...formData, day: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                required
              >
                {days.map(day => (
                  <option key={day} value={day}>{day}</option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Heure de d√©but</label>
              <input
                type="time"
                value={formData.startTime}
                onChange={(e) => setFormData({ ...formData, startTime: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Dur√©e (minutes)</label>
              <input
                type="number"
                value={formData.duration}
                onChange={(e) => setFormData({ ...formData, duration: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                min="15"
                step="15"
                required
              />
            </div>

            <div className="col-span-2">
              <label className="block text-sm font-medium text-gray-700 mb-1">Nombre de places</label>
              <input
                type="number"
                value={formData.capacity}
                onChange={(e) => setFormData({ ...formData, capacity: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                min="1"
                required
              />
            </div>
          </div>

          <div className="flex space-x-3 pt-2">
            <button
              type="submit"
              className="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700"
            >
              Enregistrer
            </button>
            <button
              type="button"
              onClick={onCancel}
              className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg font-medium hover:bg-gray-400"
            >
              Annuler
            </button>
          </div>
        </form>
      );
    }

    function AdminEventsPanel({ events, saveEvents }) {
      const [editingEvent, setEditingEvent] = useState(null);
      const [showAddForm, setShowAddForm] = useState(false);

      const handleDelete = (eventId) => {
        const event = events.find(e => e.id === eventId);
        const hasParticipants = event.participants.length > 0 || event.waitlist.length > 0;
        
        if (hasParticipants) {
          if (!confirm(`Cet √©v√©nement a ${event.participants.length} participant(s) et ${event.waitlist.length} personne(s) en liste d'attente. √ätes-vous s√ªr de vouloir le supprimer ?`)) {
            return;
          }
        } else if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet √©v√©nement ?')) {
          return;
        }
        
        saveEvents(events.filter(e => e.id !== eventId));
      };

      const handleSaveEvent = (event) => {
        if (event.id) {
          saveEvents(events.map(e => e.id === event.id ? event : e));
        } else {
          const newEvent = { 
            ...event, 
            id: Date.now(), 
            participants: [], 
            waitlist: [] 
          };
          saveEvents([...events, newEvent]);
        }
        setEditingEvent(null);
        setShowAddForm(false);
      };

      // Trier les √©v√©nements par date
      const sortedEvents = [...events].sort((a, b) => new Date(a.date) - new Date(b.date));

      return (
        <div>
          <h1 className="text-3xl font-bold text-gray-800 mb-6">Gestion des √©v√©nements ponctuels</h1>

          <div className="mb-6 flex items-center justify-between">
            <button
              onClick={() => setShowAddForm(true)}
              className="bg-green-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors"
            >
              <Icon name="plus" className="inline mr-2" />
              Cr√©er un √©v√©nement
            </button>

            <div className="text-sm text-gray-600 bg-blue-50 px-4 py-2 rounded-lg">
              <strong>{events.length}</strong> √©v√©nement(s) planifi√©(s)
            </div>
          </div>

          {showAddForm && (
            <div className="bg-white rounded-xl shadow-md p-6 mb-6">
              <h3 className="text-lg font-semibold mb-4">Nouvel √©v√©nement</h3>
              <EventForm
                onSave={handleSaveEvent}
                onCancel={() => setShowAddForm(false)}
              />
            </div>
          )}

          {sortedEvents.length === 0 ? (
            <div className="bg-white rounded-xl shadow-md p-12 text-center">
              <Icon name="calendar" className="text-6xl text-gray-300 mb-4" />
              <p className="text-gray-600 text-lg">Aucun √©v√©nement cr√©√©</p>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {sortedEvents.map(event => (
                <EventAdminCard 
                  key={event.id}
                  event={event}
                  editingEvent={editingEvent}
                  onEdit={setEditingEvent}
                  onSave={handleSaveEvent}
                  onCancel={() => setEditingEvent(null)}
                  onDelete={handleDelete}
                />
              ))}
            </div>
          )}
        </div>
      );
    }

    function EventAdminCard({ event, editingEvent, onEdit, onSave, onCancel, onDelete }) {
      if (editingEvent?.id === event.id) {
        return (
          <div className="bg-white rounded-lg shadow-md p-6">
            <EventForm
              event={editingEvent}
              onSave={onSave}
              onCancel={onCancel}
            />
          </div>
        );
      }

      return (
        <div className="bg-white rounded-lg shadow-md p-6">
          <div className="flex justify-between items-start mb-4">
            <div className="flex-1">
              <h3 className="text-lg font-bold text-gray-800 mb-1">{event.title}</h3>
              <p className="text-sm text-gray-600">
                üìÖ {new Date(event.date).toLocaleDateString('fr-FR', { 
                  weekday: 'long', 
                  day: 'numeric', 
                  month: 'long', 
                  year: 'numeric' 
                })}
              </p>
              <p className="text-sm text-gray-600">
                üïê {event.startTime} - {getEndTime(event.startTime, event.duration)}
              </p>
              <p className="text-sm text-gray-500">
                Dur√©e: {event.duration} min
                {event.capacity !== 'unlimited' && ` | Capacit√©: ${event.capacity} places`}
                {event.capacity === 'unlimited' && ` | Capacit√©: illimit√©e`}
              </p>
              {event.description && (
                <p className="text-sm text-gray-700 mt-2 italic">"{event.description}"</p>
              )}
            </div>
            <div className="flex gap-2 ml-4">
              <button
                onClick={() => onEdit(event)}
                className="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-1"
                title="Modifier"
              >
                <Icon name="edit" className="text-base" />
                <span>Modifier</span>
              </button>
              <button
                onClick={() => onDelete(event.id)}
                className="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-1"
                title="Supprimer"
              >
                <Icon name="trash-2" className="text-base" />
                <span>Supprimer</span>
              </button>
            </div>
          </div>

          <div className="border-t pt-4">
            <p className="text-sm font-semibold text-gray-700 mb-2">
              Participants ({event.participants.length}
              {event.capacity !== 'unlimited' && `/${event.capacity}`}) :
            </p>
            {event.participants.length === 0 ? (
              <p className="text-sm text-gray-500 italic">Aucun participant</p>
            ) : (
              <div className="space-y-1 max-h-32 overflow-y-auto">
                {event.participants.map((email, idx) => (
                  <div key={idx} className="text-sm text-gray-700 flex items-center">
                    <Icon name="check" className="text-green-600 mr-2 text-xs flex-shrink-0" />
                    <span className="truncate">{email}</span>
                  </div>
                ))}
              </div>
            )}

            {event.waitlist.length > 0 && (
              <>
                <p className="text-sm font-semibold text-gray-700 mb-2 mt-4">
                  Liste d'attente ({event.waitlist.length}) :
                </p>
                <div className="space-y-1 max-h-24 overflow-y-auto">
                  {event.waitlist.map((email, idx) => (
                    <div key={idx} className="text-sm text-gray-700 flex items-center">
                      <Icon name="clock" className="text-yellow-600 mr-2 text-xs flex-shrink-0" />
                      <span className="truncate">#{idx + 1} - {email}</span>
                    </div>
                  ))}
                </div>
              </>
            )}
          </div>
        </div>
      );
    }

    function EventForm({ event, onSave, onCancel }) {
      const [formData, setFormData] = useState(event || {
        title: '',
        description: '',
        date: '',
        startTime: '14:00',
        duration: 120,
        capacity: 30
      });
      const [isUnlimited, setIsUnlimited] = useState(event?.capacity === 'unlimited');

      const handleSubmit = (e) => {
        e.preventDefault();
        onSave({ 
          ...event, 
          ...formData,
          duration: parseInt(formData.duration),
          capacity: isUnlimited ? 'unlimited' : parseInt(formData.capacity)
        });
      };

      return (
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Titre</label>
            <input
              type="text"
              value={formData.title}
              onChange={(e) => setFormData({ ...formData, title: e.target.value })}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <textarea
              value={formData.description}
              onChange={(e) => setFormData({ ...formData, description: e.target.value })}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              rows="3"
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Date</label>
              <input
                type="date"
                value={formData.date}
                onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Heure de d√©but</label>
              <input
                type="time"
                value={formData.startTime}
                onChange={(e) => setFormData({ ...formData, startTime: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Dur√©e (minutes)</label>
              <input
                type="number"
                value={formData.duration}
                onChange={(e) => setFormData({ ...formData, duration: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                min="15"
                step="15"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Nombre de places</label>
              <div className="flex items-center space-x-2">
                <input
                  type="number"
                  value={formData.capacity}
                  onChange={(e) => setFormData({ ...formData, capacity: e.target.value })}
                  className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  min="1"
                  required={!isUnlimited}
                  disabled={isUnlimited}
                />
                <label className="flex items-center text-sm text-gray-700 whitespace-nowrap">
                  <input
                    type="checkbox"
                    checked={isUnlimited}
                    onChange={(e) => setIsUnlimited(e.target.checked)}
                    className="mr-1"
                  />
                  Illimit√©
                </label>
              </div>
            </div>
          </div>

          <div className="flex space-x-3 pt-2">
            <button
              type="submit"
              className="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700"
            >
              Enregistrer
            </button>
            <button
              type="button"
              onClick={onCancel}
              className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg font-medium hover:bg-gray-400"
            >
              Annuler
            </button>
          </div>
        </form>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
